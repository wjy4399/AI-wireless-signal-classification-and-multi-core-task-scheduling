# affinity-task-scheduling-system
使用贪心算法优化我的代码，使其在满足约束条件下获得更高分数。约束条件为：“
在基站系统中，共有 M 台机器和 N 项任务待处理，任务定义为= <MsgType, 
UsrInst, ExeTime, DeadLine>，携带以下几项信息：

##### MsgType：基站处理的任务类型，范围 0 ≤ 𝑀𝑠𝑔𝑇𝑦𝑝𝑒 ≤ 200
##### UsrInst：基站接入的用户实例号，范围 0 ≤ 𝑈𝑠𝑟𝐼𝑛𝑠𝑡 ≤ 10000
##### ExeTime：处理本任务耗时，简化为整数，其范围 1 ≤ ExeTime≤ 4000；
##### DeadLine：任务进入系统即开始计时，在此之前需要处理完，其范围 1 ≤DeadLine ≤ 4294967295;
##### 保证<MsgType, UsrInst>唯一，即每条任务都是独一无二的，你需要将 N 个待处理的任务，依照时间顺序分配到 M 个机器上。
### 分配的约束要求包括：
##### 同一用户实例的任务顺序不能乱序，只有当某任务的前序任务均完成时，该任务才可以启动
##### 一个机器同时只能处理一个任务
##### 当一个任务启动时，必须执行完毕
##### 不同核的执行时序无法保证，核内的执行时序能保证为:先进先出，即同一个用户的任务不能分配到不同的核上，因为无法保证执行时序
##### 必须完成所有任务的分配核在执行任务处理任务时，如果任务类型不断变更，则核需要不断切换加载不同指令，导致 CacheMiss 提高。”分数公式为：“优化目标
#### 亲和性评价(AffinityScore)：影响处理效率。当一个 Core 连续处理两条相同类型
的任务时亲和性较好，亲和得分+1，如出现连续处理多条相同类型任务时，分别
计算每两个相邻任务的亲和得分并累加。
#### 处理能力评价(CapabilityScore)：处理能力，给定系统最大处理时长 C 以及每个任
务的最晚结束时间，处理不超时的任务总数即为处理能力得分。
基于以上评价维度，选手单个用例的得分评价公式定义为：

### 选手得分$= \textit{亲 和 性 得 分 }+ \textit{未 超 时 的 任 务 数 }$

为了平衡各个用例集规模导致的得分差异，需要进行归一化处理。针对此评分公式，
我们可以得出一个绝对上界：

### 绝对上界$= \textit{任务数 N}+ \textit{任务数 N}$

基于此进行得分的归一化和规格扩充，选手单用例的最终得分评价为：

### 单个用例调度得分$=100000*log10(N)*\left(1+\frac{\textit{选手得分}-\textit{绝对上界}}{\textit{绝对上界}}\right)$”



### 亲和度优先策略
#### 1.任务分类
按照 UsrInst 将任务分类，形成多个用户实例的任务队列。并且根据每个用户的第一个任务的DeadLine为排序依据来对用户实例排序。
#### 2.初始化
初始化每个核的任务队列和每个核的最终完成时间core_endtime，开始无任务的时候设置为0,。
#### 3. 逐个用户处理
对于每个用户实例，按照以下步骤进行处理：
##### 3.1 任务排序
###### 1.任务排序
根据任务的 DeadLine 对该用户的任务进行排序，确保任务顺序不被打乱。
##### 3.2 初步分配策略
###### 1.选择核
在所有核中的所有任务与该用户的任务进行匹配，匹配到和该用户的任务类型相同的最多的任务的核，选择该核，如果所有核都没有相同类型的任务，选择core_endtime最小的核。如果四个核的任务数量最高核最低的差别太大了（满足最多任务的核的任务数量减去最少的数量大于最少的任务的数量（最低满足50）），则强制选择最少数量的核，举个例子，4个核的数量分别为500,400,400,200，那么500-200>200并且500-200>50，则选择数量为200的核。

##### 3.3 任务分配

###### 1.分配任务
如果处理该用户的第一个任务A，首先定义最晚开始时间latest_start_time为该任务的deadline-exetime，然后以该时间为节点，如果该核的core_endtime小于latest_start_time，则从该核的最后一个任务向前进行匹配，如果该核的core_endtime大于latest_start_time，则在核上找到该时间点的正在进行的任务，如果假设为任务B，依次从任务B往前匹配，假设匹配到相同类型任务C，则将该任务A放到C后面，如果匹配到该核的第一个任务都没有找到相同类型的任务，则将任务A放在任务B的前面，也就是先执行A，再执行B。如果是处理该用户的第n个任务（n不等于1），则将匹配范围限制在最多向前匹配到该用户的第n-1个任务，保证按顺序进行处理。
###### 1.更新核状态
分配任务后，更新该核的任务队列和core_endtime。core_endtime等于该核最后一个任务的实际完成时间。